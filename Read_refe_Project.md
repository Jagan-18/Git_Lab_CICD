### Kubernetes CI/CD Pipeline with GitLab
#### This repository provides a complete setup for deploying a Kubernetes-based application using GitLab CI/CD. The pipeline includes stages for installation, testing, security scanning, building, Docker image creation, and deployment to a Kubernetes cluster.

### Prerequisites
#### Before running the pipeline, ensure you have the following:
  #### - Docker installed on your machine or CI runner.
  #### - Kubernetes cluster (either local or cloud-based).
  #### -GitLab setup with a self-hosted runner or cloud-based GitLab CI/CD.
  #### -Java (JDK 17) installed for Maven builds.
  #### -Maven for Java builds.
  #### -Trivy for security scanning.
  #### -SonarQube for static code analysis.
---
### Command Script

```bash
# Update package list
sudo apt update

# Install Java 17
sudo apt install openjdk-17-jre-headless -y

# Install Maven
sudo apt install maven -y

# Install Trivy
sudo apt-get install wget apt-transport-https gnupg lsb-release -y
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
sudo apt-get update && sudo apt-get install trivy -y

# Install Docker
sudo apt install docker.io -y
sudo chmod 666 /var/run/docker.sock

# Install Kubectl
sudo snap install kubectl --classic

# Run SonarQube
docker run -d -p 9000:9000 sonarqube:lts-community
```

---

### Kubernetes Setup Scripts

#### `k8-master.sh`
```bash
#!/bin/bash

# Update package list
sudo apt-get update

# Install Docker
sudo apt install docker.io -y
sudo chmod 666 /var/run/docker.sock

# Install Kubernetes tools
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg
sudo mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl

# Initialize Kubernetes cluster
sudo kubeadm init --pod-network-cidr=10.244.0.0/16

# Set up kubeconfig for the current user
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# Install Calico network plugin
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.24.0/manifests/calico.yaml

# Install Ingress Nginx
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.49.0/deploy/static/provider/baremetal/deploy.yaml

# Check node status
kubectl get nodes
```

#### `k8s-server.sh`
```bash
#!/bin/bash

# Update package list
sudo apt-get update

# Install Docker
sudo apt install docker.io -y
sudo chmod 666 /var/run/docker.sock

# Install Kubernetes tools
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg
sudo mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl

# Join the worker node to the cluster
# Replace the join command below with the one generated by the master node
sudo kubeadm join <MASTER_NODE_IP>:6443 --token <TOKEN> --discovery-token-ca-cert-hash sha256:<HASH>
```

---

### GitLab CI Pipeline

```yaml
stages:
  - install_tools
  - test
  - security
  - build
  - deploy

install_mvn_trivy_docker_kubectl:
  stage: install_tools
  script:
    - sudo apt install openjdk-17-jre-headless -y
    - sudo apt install maven -y
    - sudo apt-get install wget apt-transport-https gnupg lsb-release -y
    - wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
    - echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
    - sudo apt-get update && sudo apt-get install trivy -y
    - sudo apt install docker.io -y && sudo chmod 666 /var/run/docker.sock
    - sudo snap install kubectl --classic
  tags:
    - self-hosted

Unit_test:
  stage: test
  script:
    - mvn test
  tags:
    - self-hosted

trivy_fs_scan:
  stage: security
  script:
    - trivy fs --format table -o fs.html .
  tags:
    - self-hosted

sonarqube-check:
  stage: security
  image: sonarsource/sonar-scanner-cli:latest
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
    GIT_DEPTH: "0"
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  allow_failure: true
  only:
    - main

Build_and_tag_push_image:
  stage: build
  script:
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - mvn package
    - docker build -t kubejaganreddy/boardgitlab:latest .
    - docker push kubejaganreddy/boardgitlab:latest
  tags:
    - self-hosted
  only:
    - main

K8s-deploy:
  stage: deploy
  variables:
    KUBECONFIG_PATH: /home/ubuntu/.kube/config
  before_script:
    - mkdir -p $(dirname "$KUBECONFIG_PATH")
    - echo "$KUBECONFIG_CONTENT" | base64 -d > "$KUBECONFIG_PATH"
    - export KUBECONFIG="$KUBECONFIG_PATH"
  script:
    - kubectl apply -f deployment-service.yaml
  tags:
    - self-hosted
  only:
    - main
```

---

### README.md

```markdown
# Kubernetes and CI/CD Pipeline Setup

This repository contains scripts and a GitLab CI/CD pipeline to set up a Kubernetes cluster and deploy applications.

## Prerequisites
- Ubuntu-based system
- Docker installed
- GitLab Runner configured

## Steps

### 1. Install Tools
Run the following commands to install required tools:
```bash
sudo apt update
sudo apt install openjdk-17-jre-headless maven docker.io -y
sudo chmod 666 /var/run/docker.sock
sudo snap install kubectl --classic
```

### 2. Set Up Kubernetes Cluster
- **Master Node**: Run `k8-master.sh` on the master node.
- **Worker Node**: Run `k8s-server.sh` on the worker node and join it to the cluster using the join command from the master node.

### 3. GitLab CI/CD Pipeline
The pipeline consists of the following stages:
1. **Install Tools**: Installs Java, Maven, Trivy, Docker, and Kubectl.
2. **Unit Test**: Runs unit tests using Maven.
3. **Security**: Performs Trivy filesystem scan and SonarQube analysis.
4. **Build**: Builds and pushes a Docker image.
5. **Deploy**: Deploys the application to the Kubernetes cluster.

### 4. Run SonarQube
Start SonarQube using:
```bash
docker run -d -p 9000:9000 sonarqube:lts-community
```

### 5. Deploy Application
The pipeline will automatically deploy the application to the Kubernetes cluster.

## Notes
- Replace placeholders in the scripts (e.g., `<MASTER_NODE_IP>`, `<TOKEN>`, `<HASH>`) with actual values.
- Ensure the GitLab Runner is properly configured and tagged as `self-hosted`.

## License
This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.
```
---




